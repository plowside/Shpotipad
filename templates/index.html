<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://kit.fontawesome.com/d8f55a29ad.js" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/wavesurfer.js"></script>
	<title>Shpotipad - Main</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			font-size: 18px;
			margin: 0;
			padding: 0;
		}

		::-webkit-scrollbar {123
			width: 7px;
			border-radius: 10px;
		}
		::-webkit-scrollbar-thumb {
			-webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
			background-color: rgba(219, 219, 219, 1);
			border-radius: 10px;
		}

		#sidebar {
			display: flex;
			flex-direction: column;
			height: 100%;
			width: 280px;
			position: fixed;
			top: 0;
			left: 0;
			background-color: #f0f0f0;
			overflow: hidden;
		}

		.sidebar-buttons {
			flex-grow: 1;
		}

		.sidebar-button-mainpage, .sidebar-button-trending, .sidebar-button-popular, .sidebar-button-upload {
			display: flex;
			width: 100%;
			padding: 15px 10px;
			text-align: left;
			border: none;
			background-color: transparent;
			cursor: pointer;
			transition: background-color 0.3s ease;
			font-size: 20px;
		}
		
		.sidebar-button-mainpage:hover, .sidebar-button-trending:hover, .sidebar-button-popular:hover, .sidebar-button-upload:hover {
			background-color: #ddd;
		}
		
		.sidebar-icon {
			margin-right: 10px;
		}

		.sidebar-search {
			margin: 0;
			display: flex;
			align-items: stretch;
		}

		.sidebar-search input {
			flex: 1;
			padding: 10px;
			font-size: 16px;
			border: none;
			outline: none;
			background-color: transparent;
			border: 2px solid rgba(169, 169, 169, 0.5);
			border-top-left-radius: 10px;
			border-bottom-left-radius: 10px;
		}

		.sidebar-search button {
			padding: 10px;
			font-size: 16px;
			border: none;
			outline: none;
			background-color: transparent;
			border: 2px solid rgba(169, 169, 169, 0.5);
			border-top-right-radius: 10px;
			border-bottom-right-radius: 10px;
			cursor: pointer;
		}

		.sidebar-volume {
			display: flex;
			flex-direction: row;
			justify-content: center;
			align-items: center;
			margin-left: -20px;
			margin-bottom: 20px;
			padding: 10px;
			font-size: 22px;
		}

		.sidebar-profile {
			display: flex;
			flex-direction: row;
			justify-content: center;
			align-items: center;
			margin-left: 10px;
			margin-bottom: 15px;
			outline: none;
			width: 92%;
			padding: 5px;
			border: 3px solid rgba(169, 169, 169, 0.3);
			border-radius: 14px;
			font-size: 20px;
			max-height: 50px;
		}
		.sidebar-profile:hover {
			transition: background-color 0.3s ease;
			background-color: #e0e0e0;
		}
		.sidebar-profile:active {
			transition: none;
			background-color: #d0d0d0;
		}
		.sidebar-profile p {
			margin-left: 10px;
			padding: 0px;
		}

		#content {
			margin-left: 280px;
			padding: 20px;
		}
		.sounds {
			display: flex;
			flex-wrap: wrap;
		}
		.sound-block {
			background-color: #f0f0f0;
			flex-basis: calc(33.33% - 30px);
			margin-right: 30px;
			margin-bottom: 30px;
			box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
			border-radius: 5px;
		}
		.sound-block a {
			text-decoration: none;
			color: black;
		}
		.sound-block-content {
			padding: 15px;
		}

		.sound-row {
			display: flex;
			flex-direction: row;
		}
		.sound-row-item {
			display: flex;
			flex-direction: row;
			margin-right: 5px;
			padding: 5px;
		}

		.sound-row-header {
			display: flex;
			flex-direction: row;
			margin: 0px 0px 30px 0px;
		}
		.sound-row-item-name {
			font-size: 25px;
			margin-right: auto;
		}
		.sound-row-item-stats {
			font-size: 20px;
			margin-left: auto;
			padding: 5px;
		}
		
		.sound-row-play {
			display: flex;
			flex-direction: row;
			justify-content: center;
			align-items: center;
			margin-right: 5px;
			padding: 7px;
			border: 2px solid rgba(0, 0, 0, 0.2);
			border-radius: 10px;
		}
		.sound-row-item-play {
			border-radius: 10px;
			border: 2px solid rgba(0, 0, 0, 0.1);
			background-color: rgba(0, 0, 0, 0.1);
			font-size: 20px;
			padding: 5px;
			width: 35px;
			margin-right: auto;
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background-color 0.3s ease;
			cursor: pointer;
		}
		.sound-row-item-play:hover {
			background-color: rgba(0, 0, 0, 0.2);
		}

		.sound-row-item-play:active {
			background-color: rgba(0, 0, 0, 0.3);
		}
		.sound-row-item-timeline {
			width: 75%;
			height: 30px;
			padding: 5px;
			margin-right: none;
		}
		.sound-row-item-duration {
			margin-left: auto;
			font-size: 16px;
		}


		.sound-row-tags {
			display: flex;
			flex-wrap: wrap;
			font-size: 12px;
			margin: 15px 0px 15px 0px;
		}
		.sound-row-item-tag {
			background-color: darkblue;
			color: #fff;
			padding: 3px;
			border-radius: 10px;
			margin: 2px 6px 5px 0px;
		}

		.sound-row-dwn {
			display: flex;
			flex-direction: row;
			justify-content: center;
			align-items: center;
		}
		.sound-row-item-addtos {
			outline: none;
			border: none;
			border-radius: 10px;
			border: 2px solid rgba(169, 169, 169, 0.5);
			background-color: transparent;
			font-size: 20px;
			padding: 5px;
			margin-right: auto;
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background-color 0.3s ease;
			cursor: pointer;
		}

		.sound-row-item-addtos:hover {
			background-color: rgba(0, 0, 0, 0.1);
		}

		.sound-row-item-addtos:active {
			background-color: rgba(0, 0, 0, 0.2);
		}


		.sound-row-item-dwn {
			margin-left: auto;
			padding: 5px;
			cursor: pointer;
		}

		.sound-row-item-share {
			margin-left: auto;
			padding: 5px;
			cursor: pointer;
		}

		.sound-row-item-dropdown {
			margin: 0px 5px 0px auto;
			padding: 5px;
			cursor: pointer;
		}
	
	input[type="range"] {
		-webkit-appearance: none;
		-moz-appearance: none;
		appearance: none;
		width: 200px;
		background-color: transparent;

		&:focus {
			outline-color: #f8b195;
		}
	}

	input[type="range"]::-webkit-slider-runnable-track {
		-webkit-appearance: none;
		appearance: none;
		height: 3px;
		background: rgb(246, 114, 128);
		background: -webkit-linear-gradient(
			left,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		background: linear-gradient(
			to right,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		filter: progid:DXImageTransform.Microsoft.gradient(
			startColorstr="#f67280",
			endColorstr="#355c7d",
			GradientType=1
		);
	}

	input[type="range"]::-moz-range-track {
		-moz-appearance: none;
		appearance: none;
		height: 3px;
		background: rgb(246, 114, 128);
		background: -moz-linear-gradient(
			left,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		background: linear-gradient(
			to right,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		filter: progid:DXImageTransform.Microsoft.gradient(
			startColorstr="#f67280",
			endColorstr="#355c7d",
			GradientType=1
		);
	}

	input[type="range"]::-ms-track {
		-webkit-appearance: none;
		-moz-appearance: none;
		appearance: none;
		height: 3px;
		background: rgb(246, 114, 128);
		background: -moz-linear-gradient(
			left,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		background: -webkit-linear-gradient(
			left,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		background: linear-gradient(
			to right,
			rgba(246, 114, 128, 1) 0%,
			rgba(192, 108, 132, 1) 50%,
			rgba(53, 92, 125, 1) 100%
		);
		filter: progid:DXImageTransform.Microsoft.gradient(
			startColorstr="#f67280",
			endColorstr="#355c7d",
			GradientType=1
		);
	}
	input[type="range"]::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		border: 2px solid #f8b195;
		border-radius: 50%;
		height: 20px;
		width: 20px;
		position: relative;
		bottom: 8px;
		background: #222
		center no-repeat;
		background-size: 50%;
		box-shadow: 0px 3px 5px 0px rgba(0, 0, 0, 0.4);
		cursor: grab;
		&:active {
			cursor: grabbing;
		}
	}

	input[type="range"]::-moz-range-thumb {
		-moz-appearance: none;
		appearance: none;
		border: 2px solid #f8b195;
		border-radius: 50%;
		height: 20px;
		width: 20px;
		position: relative;
		bottom: 8px;
		background: #222
		center no-repeat;
		background-size: 50%;
		box-shadow: 0px 3px 5px 0px rgba(0, 0, 0, 0.4);
		cursor: grab;
		&:active {
			cursor: grabbing;
		}
	}

	input[type="range"]::-ms-thumb {
		-webkit-appearance: none;
		-moz-appearance: none;
		appearance: none;
		border: 2px solid #f8b195;
		border-radius: 50%;
		height: 20px;
		width: 20px;
		position: relative;
		bottom: 8px;
		background: #222
		center no-repeat;
		background-size: 50%;
		box-shadow: 0px 3px 5px 0px rgba(0, 0, 0, 0.4);
		cursor: grab;
		&:active {
			cursor: grabbing;
		}
	}
	</style>
</head>
<body>

	<div id="sidebar">
		<img src="static/images/logo.png" alt="Logo" style="width: 100%; margin-bottom: 20px;">
		<div class="sidebar-buttons">
			<button class="sidebar-button-mainpage"><i class="sidebar-icon fa fa-bars"></i>FrontPage</button>
			<button class="sidebar-button-trending"><i class="sidebar-icon fa-solid fa-arrow-up"></i>Trending</button>
			<button class="sidebar-button-popular" onclick="redirectToAnotherPage()"><i class="sidebar-icon fa-solid fa-fire"></i>Popular</button>
			<button class="sidebar-button-upload" onclick="openMenuUpload()"><i class="sidebar-icon fa-solid fa-upload"></i>Upload</button>
		</div>
		<div class="sidebar-volume">
			<i class="sidebar-icon fa-solid fa-volume-high" style="margin-left: 15px;"></i>
			<input type="range" id="volumeControl" min="0" max="1" value="0.3" step="0.01" oninput="setVolume(this.value)">
		</div>
		<button class="sidebar-profile" onclick="openMenuProfile()">
			<i class="fa-regular fa-user"></i>
			<p>Log In</p>
		</div>

	</div>

	<div id="content">
		<div class="sidebar-search">
			<input type="text" placeholder="Search">
			<button><i class="fa-solid fa-magnifying-glass"></i></button>
		</div>
		<h1>Основное содержимое</h1>
		<p>Это основное содержимое страницы.</p>


		<div class="sounds"></div>
	</div>
	<div class="profileModal"></div>
	<script>
		var element_search_input = document.querySelector('.sidebar-search input');
		var element_sounds = document.querySelector('.sounds');
		var sounds_state = 'new';
		var wavesurfers = {'current': {'sound_id': null, 'obj': null}};


		async function req_post(url = '', data = {}) {
			var req = await fetch(url, {method: 'POST',headers: {'Content-Type': 'application/json'},body: JSON.stringify(data)});
			if (!req.ok) { throw new Error('Network response was not ok'); }
			return req.json();
		}
		
		async function req_get(url = '', params = {}) {
			var req = await fetch(new URLSearchParams(params).toString() ? `${url}?${new URLSearchParams(params).toString()}` : url, {method: 'GET'});
			if (!req.ok) { throw new Error('Network response was not ok'); }
			return req.json();
		}

		async function searchResults(_limit = [0, 20]) {
			(async () => {
				try {
					var resp = await req_get('api/search', {q: q = element_search_input.value, limit: _limit});
					if (resp['status'] == false){
						alert('Cant get sounds: '+resp['message']);
					} else {
						addSoundsResults(resp['sounds']);
					}
				} catch {
					console.error('Error on get_sounds:', error);
				}
			})();
		}

		async function downloadBlob(url, filename) {
			try {
				var resp = await fetch(url);
				var blob = await resp.blob();
				var a = document.createElement("a");
				var objectUrl = window.URL.createObjectURL(blob);
				a.href = objectUrl;
				a.download = filename;
				a.click();
				window.URL.revokeObjectURL(objectUrl);
			} catch (error) {
				console.error("Error downloading Sound:", error);
			}
		}

		let timeoutId;
		element_search_input.addEventListener('input', function() {
			clearTimeout(timeoutId);
			timeoutId = setTimeout(searchResults, 300);
		});
		element_search_input.addEventListener('Enter', function() {
			searchResults();
		});

		async function addSoundsResults(sounds_results) {
			deleteWavesurfers();
			element_sounds.innerHTML = '';
			sounds_results.forEach(function(sound_result){
				var div = `
	<div class="sound-block">
		<div class="sound-block-content" sound_id=`+ sound_result['sound_id'] +`>
			<div class="sound-row-header">
				<div class="sound-row-item-name">`+ sound_result['sound_name'] +`</div>
				<div class="sound-row-item-stats"><a href="asd">±`+ sound_result['sound_stats'] +`</a></div>
			</div>
			<div class="sound-row-play">
				<div class="sound-row-item" style="margin-right: auto;">
					<button class="sound-row-item-play" onclick="playSound(`+ sound_result['sound_id'] +`)"><i class="fa-solid fa-play"></i></button>
				</div>
				<div class="sound-row-item-timeline"></div>
				<div class="sound-row-item-duration">`+ sound_result['sound_duration'] +` sec.</div>
			</div>
			<div class="sound-row-tags">`;
			sound_result['sound_tags'].forEach(function(x){
				var tag = x.split('|');
				if (tag[1] == 0){
					div += `\n				<div class="sound-row-item-tag">`+ tag[0] +`</div>`;
				} else if (tag[1] == 1){
					div += `\n				<div class="sound-row-item-tag">`+ tag[0] +`</div>`;
				}
			});

			div += `</div>
			<div class="sound-row-dwn">
				<button class="sound-row-item-addtos"><img width="32" height="32" src="https://img.icons8.com/nolan/64/soundpad.png" alt="soundpad"/>Add to Shpotipad</button>
				<div class="sound-row-item-dwn"><a onClick="javascript:downloadBlob('sound/` + sound_result['sound_id'] + `', '` + sound_result['sound_id'] + '-' + sound_result['sound_name'].replace(/ /g, "-") + `.mp3')" target="_blank">` + sound_result['sound_downloads'] + ` <i class="fa-solid fa-download"></i></a></div>
				<div class="sound-row-item-share"><i class="fa-solid fa-share"></i></div>
				<div class="sound-row-item-dropdown"><i class="fa-solid fa-ellipsis-vertical"></i></div>
			</div>
		</div>
	</div>`;
			element_sounds.innerHTML += div;
			});
		}
	

	async function setVolume(new_value) {
		if (new_value){
			localStorage.setItem('volume', new_value);
		}
		var wavesurfer = wavesurfers['current']['obj'];
		if (wavesurfer){
			wavesurfer.setVolume(localStorage.getItem('volume'));
		}
	}

	async function deleteWavesurfers() {
		if (wavesurfers['current']['obj']){
			wavesurfers['current']['obj'].destroy();
		}
		wavesurfers = {'current': {'sound_id': null, 'obj': null}};
	}

	async function initializeWaveform(element, sound_id, src) {
		if (wavesurfers['current']['obj']){
			wavesurfers['current']['obj'].destroy();
		}
		delete wavesurfers[src];
		var wavesurfer = WaveSurfer.create({
			container: element,
			height: 30,
			waveColor: '#c7cace',
			progressColor: '#848894'
		});
		wavesurfer.on('finish', function () {
			playSound(sound_id, true);
		});
		wavesurfers[src] = wavesurfer;
		wavesurfers['current']['obj'] = wavesurfer;
		wavesurfers['current']['sound_id'] = sound_id;
		setVolume(null)
		wavesurfer.load(src);
	}

	async function playSound(sound_id, pause = false){
		var soundBlockElement = document.querySelector('.sound-block-content[sound_id="'+sound_id+'"]');
		var soundTimelineElement = soundBlockElement.querySelector('.sound-row-item-timeline');
		//soundTimelineElement.innerHTML = ``;
		var wavesurfer = wavesurfers['current'];
		if (pause) {
			soundBlockElement.querySelector('.sound-row-item-play').innerHTML = '<i class="fa-solid fa-play"></i>';
			return wavesurfer['obj'].pause();
		}
		if (wavesurfer['sound_id'] == sound_id){
			if (wavesurfer['obj'].isPlaying()){
				soundBlockElement.querySelector('.sound-row-item-play').innerHTML = '<i class="fa-solid fa-play"></i>';
				wavesurfer['obj'].pause();
			} else {
				soundBlockElement.querySelector('.sound-row-item-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
				wavesurfer['obj'].play();
			}
		} else {
			var previousWavesurfer = wavesurfers['current'];
			if (previousWavesurfer['sound_id']){
				document.querySelector('.sound-block-content[sound_id="'+previousWavesurfer['sound_id']+'"]').querySelector('.sound-row-item-play').innerHTML = '<i class="fa-solid fa-play"></i>';
			}
			initializeWaveform(soundTimelineElement, sound_id, 'sound/'+sound_id);
			wavesurfer = wavesurfers['current'];
			wavesurfer['obj'].play();
			soundBlockElement.querySelector('.sound-row-item-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
		}
	}
	async function openMenuUpload(){
		var profileModal = document.querySelector('profileModal');
		profileModal.innerHTML = ``;
		
	}
	async function openMenuProfile(){
		var profileModal = document.querySelector('profileModal');
		profileModal.innerHTML = ``;

	}
	searchResults();

	function redirectToAnotherPage() {
    window.location.href = "popular";
}
	</script>
</body>
</html>